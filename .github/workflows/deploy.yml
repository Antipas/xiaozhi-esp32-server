name: Deploy Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 110m
          script_stop: true
          script: |
            set -eux

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            COMPOSE_FILE="${{ secrets.DOCKER_COMPOSE_FILE }}"
            PULL_POLICY="${{ secrets.DEPLOY_PULL_POLICY }}"
            DEPLOY_ASYNC="${{ secrets.DEPLOY_ASYNC }}"
            BRANCH="${{ github.ref_name }}"
            echo "Deploy user: $(whoami)"
            echo "Deploy path: $DEPLOY_PATH"
            echo "Branch: $BRANCH"

            if [ -z "$DEPLOY_PATH" ]; then
              echo "DEPLOY_PATH is empty."
              exit 1
            fi

            cd "$DEPLOY_PATH"

            if [ -n "$COMPOSE_FILE" ] && [ -f "$COMPOSE_FILE" ]; then
              :
            elif [ -f "main/xiaozhi-server/docker-compose_all.yml" ]; then
              COMPOSE_FILE="main/xiaozhi-server/docker-compose_all.yml"
            elif [ -f "main/xiaozhi-server/docker-compose.yml" ]; then
              COMPOSE_FILE="main/xiaozhi-server/docker-compose.yml"
            elif [ -f "docker-compose_all.yml" ]; then
              COMPOSE_FILE="docker-compose_all.yml"
            elif [ -f "docker-compose.yml" ]; then
              COMPOSE_FILE="docker-compose.yml"
            else
              echo "No compose file found. Tried:"
              echo " - $COMPOSE_FILE"
              echo " - main/xiaozhi-server/docker-compose_all.yml"
              echo " - main/xiaozhi-server/docker-compose.yml"
              echo " - docker-compose_all.yml"
              echo " - docker-compose.yml"
              exit 1
            fi

            echo "Using compose file: $COMPOSE_FILE"
            ls -l "$COMPOSE_FILE"

            if [ -z "$PULL_POLICY" ]; then
              PULL_POLICY="missing"
            fi
            echo "Image pull policy: $PULL_POLICY"

            if [ -z "$DEPLOY_ASYNC" ]; then
              DEPLOY_ASYNC="true"
            fi
            echo "Async deploy: $DEPLOY_ASYNC"

            check_git_objects_writable() {
              [ -d ".git/objects" ] || return 1
              [ -w ".git/objects" ] || return 1
              test_dir=".git/objects/_perm_test_$$"
              mkdir "$test_dir" 2>/dev/null || return 1
              rmdir "$test_dir" 2>/dev/null || true
              return 0
            }

            has_passwordless_sudo() {
              command -v sudo >/dev/null 2>&1 && sudo -n true >/dev/null 2>&1
            }

            repair_git_permissions() {
              if has_passwordless_sudo; then
                sudo chown -R "$(whoami)":"$(id -gn)" .git || true
                sudo find .git -type d -exec chmod u+rwx {} \; || true
                sudo find .git -type f -exec chmod u+rw {} \; || true
              else
                find .git -type d -exec chmod u+rwx {} \; || true
                find .git -type f -exec chmod u+rw {} \; || true
              fi
              rm -f .git/index.lock .git/shallow.lock .git/packed-refs.lock || true
            }

            # Ensure repository permissions are writable for the current deploy user.
            if [ ! -d ".git" ]; then
              echo "No .git directory found under DEPLOY_PATH: $DEPLOY_PATH"
              exit 1
            fi
            rm -f .git/index.lock .git/shallow.lock .git/packed-refs.lock || true

            USE_SUDO_GIT="false"
            if ! check_git_objects_writable; then
              echo ".git/objects is not writable by current user: $(whoami)"
              if has_passwordless_sudo; then
                USE_SUDO_GIT="true"
                repair_git_permissions
              else
                echo "sudo not available without password; cannot auto-fix .git permissions."
              fi
            fi

            if ! check_git_objects_writable && [ "$USE_SUDO_GIT" != "true" ]; then
              echo "FATAL: .git/objects is still not writable and sudo git is unavailable."
              echo "Please run on server once:"
              echo "  sudo chown -R $(whoami):$(id -gn) \"$DEPLOY_PATH/.git\""
              echo "  sudo find \"$DEPLOY_PATH/.git\" -type d -exec chmod u+rwx {} \\;"
              echo "  sudo find \"$DEPLOY_PATH/.git\" -type f -exec chmod u+rw {} \\;"
              exit 1
            fi

            run_git() {
              if [ "$USE_SUDO_GIT" = "true" ]; then
                sudo -E git -c safe.directory="$DEPLOY_PATH" "$@"
              else
                git -c safe.directory="$DEPLOY_PATH" "$@"
              fi
            }

            echo "Running git fetch..."
            set +e
            FETCH_OUTPUT="$(run_git fetch --all --prune 2>&1)"
            FETCH_CODE=$?
            set -e
            if [ "$FETCH_CODE" -ne 0 ]; then
              echo "git fetch failed (first attempt):"
              echo "$FETCH_OUTPUT"
              echo "Trying git permission repair and retry..."
              repair_git_permissions
              set +e
              FETCH_OUTPUT="$(run_git fetch --all --prune 2>&1)"
              FETCH_CODE=$?
              set -e
              if [ "$FETCH_CODE" -ne 0 ]; then
                echo "git fetch failed (second attempt):"
                echo "$FETCH_OUTPUT"
                exit 1
              fi
            fi
            echo "Running git checkout..."
            run_git checkout "$BRANCH"
            echo "Running git pull..."
            run_git pull origin "$BRANCH" --ff-only
            echo "Git sync completed."

            if docker compose version >/dev/null 2>&1; then
              USE_DOCKER_COMPOSE_PLUGIN="1"
            elif command -v docker-compose >/dev/null 2>&1; then
              USE_DOCKER_COMPOSE_PLUGIN="0"
            else
              echo "No docker compose command found. Install Docker Compose plugin or docker-compose."
              exit 1
            fi

            export DEPLOY_PATH COMPOSE_FILE PULL_POLICY USE_DOCKER_COMPOSE_PLUGIN
            DEPLOY_RUN_SCRIPT="$DEPLOY_PATH/.deploy_run.sh"
            cat > "$DEPLOY_RUN_SCRIPT" <<'EOF'
            #!/bin/sh
            set -eu

            cd "$DEPLOY_PATH"

            if [ "$USE_DOCKER_COMPOSE_PLUGIN" = "1" ]; then
              if [ "$PULL_POLICY" = "never" ]; then
                docker compose -f "$COMPOSE_FILE" up -d --remove-orphans --pull never
              else
                docker compose -f "$COMPOSE_FILE" up -d --remove-orphans --pull "$PULL_POLICY"
              fi
            else
              if [ "$PULL_POLICY" = "always" ]; then
                docker-compose -f "$COMPOSE_FILE" pull
              fi
              docker-compose -f "$COMPOSE_FILE" up -d --remove-orphans
            fi

            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
            EOF
            if [ "$DEPLOY_ASYNC" = "true" ]; then
              DEPLOY_LOG_FILE="$DEPLOY_PATH/deploy.log"
              nohup sh "$DEPLOY_RUN_SCRIPT" > "$DEPLOY_LOG_FILE" 2>&1 < /dev/null &
              echo "Deployment started in background. PID=$!"
              echo "Deploy log: $DEPLOY_LOG_FILE"
              sleep 2
              tail -n 30 "$DEPLOY_LOG_FILE" || true
              exit 0
            fi

            sh "$DEPLOY_RUN_SCRIPT"
