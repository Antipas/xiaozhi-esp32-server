name: Deploy Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 110m
          script_stop: true
          script: |
            set -eu

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            COMPOSE_FILE="${{ secrets.DOCKER_COMPOSE_FILE }}"
            PULL_POLICY="${{ secrets.DEPLOY_PULL_POLICY }}"
            DEPLOY_ASYNC="${{ secrets.DEPLOY_ASYNC }}"
            BRANCH="${{ github.ref_name }}"

            if [ -z "$DEPLOY_PATH" ]; then
              echo "DEPLOY_PATH is empty."
              exit 1
            fi

            cd "$DEPLOY_PATH"

            if [ -n "$COMPOSE_FILE" ] && [ -f "$COMPOSE_FILE" ]; then
              :
            elif [ -f "main/xiaozhi-server/docker-compose_all.yml" ]; then
              COMPOSE_FILE="main/xiaozhi-server/docker-compose_all.yml"
            elif [ -f "main/xiaozhi-server/docker-compose.yml" ]; then
              COMPOSE_FILE="main/xiaozhi-server/docker-compose.yml"
            elif [ -f "docker-compose_all.yml" ]; then
              COMPOSE_FILE="docker-compose_all.yml"
            elif [ -f "docker-compose.yml" ]; then
              COMPOSE_FILE="docker-compose.yml"
            else
              echo "No compose file found. Tried:"
              echo " - $COMPOSE_FILE"
              echo " - main/xiaozhi-server/docker-compose_all.yml"
              echo " - main/xiaozhi-server/docker-compose.yml"
              echo " - docker-compose_all.yml"
              echo " - docker-compose.yml"
              exit 1
            fi

            echo "Using compose file: $COMPOSE_FILE"
            ls -l "$COMPOSE_FILE"

            if [ -z "$PULL_POLICY" ]; then
              PULL_POLICY="missing"
            fi
            echo "Image pull policy: $PULL_POLICY"

            if [ -z "$DEPLOY_ASYNC" ]; then
              DEPLOY_ASYNC="true"
            fi
            echo "Async deploy: $DEPLOY_ASYNC"

            # Ensure repository permissions are writable for the current deploy user.
            if [ ! -d ".git" ]; then
              echo "No .git directory found under DEPLOY_PATH: $DEPLOY_PATH"
              exit 1
            fi
            rm -f .git/index.lock .git/shallow.lock .git/packed-refs.lock || true

            if [ ! -w ".git/objects" ]; then
              echo ".git/objects is not writable by current user: $(whoami)"
              if command -v sudo >/dev/null 2>&1; then
                if sudo -n true >/dev/null 2>&1; then
                  sudo chown -R "$(whoami)":"$(id -gn)" .git
                  sudo find .git -type d -exec chmod u+rwx {} \;
                  sudo find .git -type f -exec chmod u+rw {} \;
                else
                  echo "sudo requires password; cannot auto-fix .git permissions."
                fi
              else
                echo "sudo not found; cannot auto-fix .git permissions."
              fi
            fi

            if [ ! -w ".git/objects" ]; then
              echo "FATAL: .git/objects is still not writable after fix attempt."
              echo "Please run on server:"
              echo "  sudo chown -R $(whoami):$(id -gn) \"$DEPLOY_PATH/.git\""
              echo "  sudo find \"$DEPLOY_PATH/.git\" -type d -exec chmod u+rwx {} \\;"
              echo "  sudo find \"$DEPLOY_PATH/.git\" -type f -exec chmod u+rw {} \\;"
              exit 1
            fi

            git config --global --add safe.directory "$DEPLOY_PATH" || true
            git fetch --all --prune
            git checkout "$BRANCH"
            git pull origin "$BRANCH" --ff-only

            if docker compose version >/dev/null 2>&1; then
              USE_DOCKER_COMPOSE_PLUGIN="1"
            elif command -v docker-compose >/dev/null 2>&1; then
              USE_DOCKER_COMPOSE_PLUGIN="0"
            else
              echo "No docker compose command found. Install Docker Compose plugin or docker-compose."
              exit 1
            fi

            export DEPLOY_PATH COMPOSE_FILE PULL_POLICY USE_DOCKER_COMPOSE_PLUGIN
            DEPLOY_RUN_SCRIPT="$DEPLOY_PATH/.deploy_run.sh"
            cat > "$DEPLOY_RUN_SCRIPT" <<'EOF'
            #!/bin/sh
            set -eu

            cd "$DEPLOY_PATH"

            if [ "$USE_DOCKER_COMPOSE_PLUGIN" = "1" ]; then
              if [ "$PULL_POLICY" = "never" ]; then
                docker compose -f "$COMPOSE_FILE" up -d --remove-orphans --pull never
              else
                docker compose -f "$COMPOSE_FILE" up -d --remove-orphans --pull "$PULL_POLICY"
              fi
            else
              if [ "$PULL_POLICY" = "always" ]; then
                docker-compose -f "$COMPOSE_FILE" pull
              fi
              docker-compose -f "$COMPOSE_FILE" up -d --remove-orphans
            fi

            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
            EOF
            if [ "$DEPLOY_ASYNC" = "true" ]; then
              DEPLOY_LOG_FILE="$DEPLOY_PATH/deploy.log"
              nohup sh "$DEPLOY_RUN_SCRIPT" > "$DEPLOY_LOG_FILE" 2>&1 < /dev/null &
              echo "Deployment started in background. PID=$!"
              echo "Deploy log: $DEPLOY_LOG_FILE"
              sleep 2
              tail -n 30 "$DEPLOY_LOG_FILE" || true
              exit 0
            fi

            sh "$DEPLOY_RUN_SCRIPT"
